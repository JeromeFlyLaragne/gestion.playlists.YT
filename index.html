<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Manager</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #fef6f8;
            --bg-tertiary: #fff9fb;
            --accent: #ff6b9d;
            --accent-hover: #ff8fb8;
            --text-primary: #2d2d2d;
            --text-secondary: #6b6b6b;
            --text-muted: #9a9a9a;
            --border: #ffd4e5;
            --success: #a0daa9;
            --warning: #ffd89b;
            --danger: #ff8fa3;
            --purple-pastel: #d4b5ff;
            --blue-pastel: #b8e0ff;
            --yellow-pastel: #fff5b8;
            --green-pastel: #c8f0d5;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comfortaa', cursive;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='2.5' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            z-index: 9999;
        }

        header {
            background: var(--bg-primary);
            border-bottom: 3px solid var(--accent);
            padding: 2rem 3rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(255, 107, 157, 0.15);
        }

        h1 {
            font-family: 'Comfortaa', cursive;
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: 0.02em;
            text-transform: none;
            color: #ff0000;
            margin-bottom: 0.5rem;
            animation: fadeInDown 0.6s ease-out;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .subtitle {
            font-family: 'Comfortaa', cursive;
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 3rem;
        }

        .auth-section {
            background: var(--yellow-pastel);
            border: 3px solid var(--border);
            padding: 3rem;
            margin-bottom: 3rem;
            text-align: center;
            animation: fadeIn 0.8s ease-out 0.2s both;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(255, 107, 157, 0.15);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .btn {
            font-family: 'Comfortaa', cursive;
            font-size: 0.875rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 1rem 2.5rem;
            border: 3px solid var(--accent);
            background: var(--accent);
            color: white;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.3);
        }

        .btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--accent-hover);
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: -1;
        }

        .btn:hover:before {
            left: 0;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.4);
        }

        .btn-danger {
            border-color: var(--danger);
            color: var(--danger);
        }

        .btn-danger:before {
            background: var(--danger);
        }

        .btn-danger:hover {
            color: var(--bg-primary);
        }

        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }

        .btn:disabled:before {
            display: none;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
            animation: fadeIn 0.8s ease-out 0.4s both;
        }

        .filter-group {
            background: var(--blue-pastel);
            border: 2px solid var(--border);
            padding: 1.5rem;
            border-radius: 15px;
            transition: transform 0.3s ease;
        }

        .filter-group:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(255, 107, 157, 0.2);
        }

        .filter-group label {
            font-family: 'Comfortaa', cursive;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        .filter-group input,
        .filter-group select {
            font-family: 'Comfortaa', cursive;
            width: 100%;
            padding: 0.875rem;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
            border-radius: 10px;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: var(--accent);
            background: white;
            box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
            animation: fadeIn 0.8s ease-out 0.6s both;
        }

        .stat-card {
            background: var(--purple-pastel);
            border-left: 6px solid var(--accent);
            padding: 1.5rem;
            transition: transform 0.3s ease;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(255, 107, 157, 0.15);
        }

        .stat-card:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 10px 30px rgba(255, 107, 157, 0.25);
        }

        .stat-card:nth-child(2) {
            background: var(--green-pastel);
            border-left-color: var(--success);
        }

        .stat-card:nth-child(3) {
            background: var(--yellow-pastel);
            border-left-color: var(--warning);
        }

        .stat-value {
            font-family: 'Comfortaa', cursive;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-label {
            font-family: 'Comfortaa', cursive;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            font-weight: 600;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 2rem;
            animation: fadeIn 0.8s ease-out 0.8s both;
        }

        .video-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(255, 107, 157, 0.1);
        }

        .video-card:hover {
            border-color: var(--accent);
            transform: translateY(-8px) rotate(1deg);
            box-shadow: 0 15px 40px rgba(255, 107, 157, 0.3);
        }

        .video-thumbnail {
            width: 100%;
            aspect-ratio: 16/9;
            object-fit: cover;
            display: block;
            transition: transform 0.5s ease;
        }

        .video-card:hover .video-thumbnail {
            transform: scale(1.05);
        }

        .video-info {
            padding: 1.5rem;
        }

        .video-title {
            font-family: 'Comfortaa', cursive;
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .video-meta {
            font-family: 'Comfortaa', cursive;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .video-playlist {
            display: inline-block;
            font-family: 'Comfortaa', cursive;
            font-size: 0.7rem;
            background: var(--green-pastel);
            color: var(--text-primary);
            padding: 0.35rem 0.85rem;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border: 2px solid var(--success);
            border-radius: 20px;
            font-weight: 600;
        }

        .video-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .btn-small {
            font-family: 'Comfortaa', cursive;
            font-size: 0.7rem;
            padding: 0.5rem 1rem;
            border: 2px solid var(--accent);
            background: var(--bg-primary);
            color: var(--accent);
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-radius: 20px;
            font-weight: 600;
        }

        .btn-small:hover {
            border-color: var(--accent);
            background: var(--accent);
            color: white;
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.3);
        }

        .loading {
            text-align: center;
            padding: 4rem;
            font-family: 'Comfortaa', cursive;
            font-size: 1rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.2em;
            font-weight: 600;
        }

        .loading:after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% {
                content: '.';
            }
            40% {
                content: '..';
            }
            60%, 100% {
                content: '...';
            }
        }

        .error {
            background: rgba(255, 51, 102, 0.1);
            border: 2px solid var(--danger);
            padding: 2rem;
            margin: 2rem 0;
            font-family: 'Comfortaa', cursive;
            color: var(--danger);
            border-radius: 15px;
        }

        .hidden {
            display: none !important;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 3px solid var(--accent);
            padding: 3rem;
            max-width: 600px;
            width: 90%;
            animation: modalIn 0.3s ease-out;
            border-radius: 25px;
            box-shadow: 0 20px 60px rgba(255, 107, 157, 0.3);
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-title {
            font-family: 'Comfortaa', cursive;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            text-transform: uppercase;
            color: var(--accent);
            font-weight: 700;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: flex-end;
        }

        #setupInstructions {
            background: rgba(255, 255, 255, 0.6);
            border: 3px dashed var(--border);
            padding: 2rem;
            margin: 2rem 0;
            font-family: 'Comfortaa', cursive;
            font-size: 0.875rem;
            line-height: 1.8;
            animation: fadeIn 0.8s ease-out;
            border-radius: 15px;
        }

        #setupInstructions h3 {
            color: var(--accent);
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        #setupInstructions h3:first-child {
            margin-top: 0;
        }

        #setupInstructions ol {
            margin-left: 1.5rem;
            margin-top: 0.75rem;
        }

        #setupInstructions li {
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        #setupInstructions code {
            background: var(--bg-primary);
            color: var(--success);
            padding: 0.125rem 0.5rem;
            border: 1px solid var(--border);
        }

        .client-id-input {
            background: rgba(255, 255, 255, 0.7);
            border: 3px solid var(--border);
            padding: 2rem;
            margin: 2rem 0;
            border-radius: 15px;
        }

        .client-id-input label {
            font-family: 'Comfortaa', cursive;
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: block;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .client-id-input input {
            font-family: 'Comfortaa', cursive;
            width: 100%;
            padding: 1rem;
            background: white;
            border: 2px solid var(--border);
            color: var(--text-primary);
            font-size: 0.875rem;
            margin-bottom: 1rem;
            border-radius: 10px;
        }

        .client-id-input input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
        }

        .playlist-checkbox-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 10px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .playlist-checkbox-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent);
            transform: translateX(5px);
        }

        .playlist-checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 1rem;
            cursor: pointer;
            accent-color: var(--accent);
        }

        .playlist-checkbox-item label {
            font-family: 'Comfortaa', cursive;
            font-size: 1rem;
            color: var(--text-primary);
            cursor: pointer;
            flex-grow: 1;
        }

        @media (max-width: 768px) {
            header {
                padding: 1.5rem;
            }

            h1 {
                font-size: 1.75rem;
            }

            .container {
                padding: 1.5rem;
            }

            .filters {
                grid-template-columns: 1fr;
            }

            .video-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="noise-overlay"></div>
    
    <header>
        <h1>Youtube Manager by JS</h1>
        <div class="subtitle">Gestionnaire de vid√©os et playlists</div>
    </header>

    <div class="container">
        <!-- Section d'authentification -->
        <div id="authSection" class="auth-section">
            <div id="setupInstructions">
                <h3>üìã Configuration requise</h3>
                <ol>
                    <li>Allez sur <code>console.cloud.google.com</code></li>
                    <li>Cr√©ez un nouveau projet ou s√©lectionnez-en un existant</li>
                    <li>Activez l'API YouTube Data API v3</li>
                    <li>Cr√©ez des identifiants OAuth 2.0 (Application Web)</li>
                    <li>Ajoutez <code>http://localhost</code> et <code>http://127.0.0.1</code> dans les URI de redirection autoris√©s</li>
                    <li>Copiez votre Client ID ci-dessous</li>
                </ol>

                <h3>üîí S√©curit√©</h3>
                <ol>
                    <li>Vos donn√©es restent sur votre machine</li>
                    <li>Connexion directe aux serveurs Google</li>
                    <li>R√©vocable √† tout moment depuis votre compte Google</li>
                </ol>
            </div>

            <div class="client-id-input">
                <label for="clientIdInput">Client ID OAuth 2.0</label>
                <input type="text" id="clientIdInput" placeholder="123456789-abcdefghijklmnop.apps.googleusercontent.com">
                <button class="btn" onclick="saveClientId()">Sauvegarder et Se connecter</button>
            </div>
        </div>

        <!-- Statistiques -->
        <div id="statsSection" class="hidden">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalVideos">0</div>
                    <div class="stat-label">Total Vid√©os</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalPlaylists">0</div>
                    <div class="stat-label">Playlists</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="filteredCount">0</div>
                    <div class="stat-label">Affich√©es</div>
                </div>
            </div>

            <!-- Filtres -->
            <div class="filters">
                <div class="filter-group">
                    <label for="searchInput">Recherche</label>
                    <input type="text" id="searchInput" placeholder="Titre de la vid√©o...">
                </div>
                <div class="filter-group">
                    <label for="playlistFilter">Playlist</label>
                    <select id="playlistFilter">
                        <option value="">Toutes les playlists</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="sortBy">Trier par</label>
                    <select id="sortBy">
                        <option value="date-desc">Date (Plus r√©cent)</option>
                        <option value="date-asc">Date (Plus ancien)</option>
                        <option value="title-asc">Titre (A-Z)</option>
                        <option value="title-desc">Titre (Z-A)</option>
                    </select>
                </div>
            </div>

            <div style="text-align: center; margin-bottom: 2rem;">
                <button class="btn btn-danger" onclick="signOut()">D√©connexion</button>
            </div>
        </div>

        <!-- Grille de vid√©os -->
        <div id="videoGrid" class="video-grid"></div>
        
        <div id="loadingIndicator" class="loading hidden">Chargement</div>
    </div>

    <!-- Modal de gestion des playlists -->
    <div id="playlistModal" class="modal hidden" style="display: none;">
        <div class="modal-content">
            <h2 class="modal-title">üìã G√©rer les playlists</h2>
            <p style="margin-bottom: 1rem; color: var(--text-secondary); font-family: 'Comfortaa', cursive;">
                Vid√©o : <span id="playlistVideoTitle" style="color: var(--text-primary); font-weight: 600;"></span>
            </p>
            <div id="playlistCheckboxes" style="max-height: 400px; overflow-y: auto; margin: 1.5rem 0;"></div>
            <div class="modal-actions">
                <button class="btn" onclick="closePlaylistModal()">Annuler</button>
                <button class="btn" style="background: var(--success); border-color: var(--success);" onclick="savePlaylistChanges()">üíæ Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- Modal de confirmation de suppression -->
    <div id="deleteModal" class="modal hidden" style="display: none;">
        <div class="modal-content">
            <h2 class="modal-title">Confirmer la suppression</h2>
            <p style="margin-bottom: 1rem; color: var(--text-secondary);">
                √ätes-vous s√ªr de vouloir supprimer cette vid√©o de votre cha√Æne ? Cette action est irr√©versible.
            </p>
            <p style="font-family: 'JetBrains Mono', monospace; font-size: 0.875rem; color: var(--text-muted);">
                Vid√©o : <span id="deleteVideoTitle" style="color: var(--text-primary);"></span>
            </p>
            <div class="modal-actions">
                <button class="btn" onclick="closeDeleteModal()">Annuler</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Supprimer</button>
            </div>
        </div>
    </div>

    <!-- Google API -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>

    <script>
        // Configuration
        let CLIENT_ID = localStorage.getItem('youtube_manager_client_id') || '';
        const API_KEY = ''; // Pas n√©cessaire avec OAuth
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/youtube.readonly https://www.googleapis.com/auth/youtube.force-ssl';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        
        let allVideos = [];
        let allPlaylists = [];
        let currentVideoToDelete = null;

        // Initialisation
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            if (CLIENT_ID) {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: '', // d√©fini plus tard
                });
                gisInited = true;
                maybeEnableButtons();
            }
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited && CLIENT_ID) {
                document.getElementById('authSection').style.display = 'block';
            }
        }

        function saveClientId() {
            const clientId = document.getElementById('clientIdInput').value.trim();
            if (!clientId) {
                alert('Veuillez entrer un Client ID valide');
                return;
            }
            CLIENT_ID = clientId;
            localStorage.setItem('youtube_manager_client_id', clientId);
            
            // Initialiser le client Google Identity Services
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // d√©fini dans handleAuthClick
            });
            gisInited = true;
            
            // Se connecter automatiquement
            handleAuthClick();
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('statsSection').classList.remove('hidden');
                await loadAllData();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function signOut() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                document.getElementById('authSection').classList.remove('hidden');
                document.getElementById('statsSection').classList.add('hidden');
                document.getElementById('videoGrid').innerHTML = '';
                allVideos = [];
                allPlaylists = [];
            }
        }

        // Chargement des donn√©es
        async function loadAllData() {
            showLoading();
            try {
                await loadPlaylists();
                await loadAllVideos();
                updateStats();
                renderVideos();
            } catch (error) {
                console.error('Erreur d√©taill√©e:', error);
                showError('Erreur lors du chargement des donn√©es: ' + (error.message || 'Erreur inconnue'));
            } finally {
                hideLoading();
            }
        }

        async function loadPlaylists() {
            let nextPageToken = '';
            allPlaylists = [];
            
            do {
                const response = await gapi.client.youtube.playlists.list({
                    part: 'snippet,contentDetails',
                    mine: true,
                    maxResults: 50,
                    pageToken: nextPageToken
                });
                
                allPlaylists = allPlaylists.concat(response.result.items || []);
                nextPageToken = response.result.nextPageToken;
            } while (nextPageToken);
            
            updatePlaylistFilter();
        }

        async function loadAllVideos() {
            allVideos = [];
            
            for (const playlist of allPlaylists) {
                const videos = await loadPlaylistVideos(playlist.id, playlist.snippet.title);
                allVideos = allVideos.concat(videos);
            }
        }

        async function loadPlaylistVideos(playlistId, playlistTitle) {
            let videos = [];
            let nextPageToken = '';
            
            do {
                const response = await gapi.client.youtube.playlistItems.list({
                    part: 'snippet,contentDetails',
                    playlistId: playlistId,
                    maxResults: 50,
                    pageToken: nextPageToken
                });
                
                const items = response.result.items || [];
                for (const item of items) {
                    // Gestion s√©curis√©e des miniatures avec smiley clin d'≈ìil sur fond pastel uni
                    let thumbnailUrl = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="320" height="180"%3E%3Crect width="320" height="180" fill="%23d4b5ff"/%3E%3Ctext x="50%25" y="50%25" font-size="60" text-anchor="middle" dominant-baseline="middle"%3Eüòâ%3C/text%3E%3C/svg%3E';
                    
                    if (item.snippet.thumbnails) {
                        if (item.snippet.thumbnails.medium && item.snippet.thumbnails.medium.url) {
                            thumbnailUrl = item.snippet.thumbnails.medium.url;
                        } else if (item.snippet.thumbnails.default && item.snippet.thumbnails.default.url) {
                            thumbnailUrl = item.snippet.thumbnails.default.url;
                        } else if (item.snippet.thumbnails.high && item.snippet.thumbnails.high.url) {
                            thumbnailUrl = item.snippet.thumbnails.high.url;
                        }
                    }
                    
                    videos.push({
                        id: item.snippet.resourceId.videoId,
                        playlistItemId: item.id,
                        title: item.snippet.title || 'Sans titre',
                        thumbnail: thumbnailUrl,
                        publishedAt: item.snippet.publishedAt,
                        playlistId: playlistId,
                        playlistTitle: playlistTitle,
                        description: item.snippet.description || ''
                    });
                }
                
                nextPageToken = response.result.nextPageToken;
            } while (nextPageToken);
            
            return videos;
        }

        // Interface utilisateur
        function updatePlaylistFilter() {
            const select = document.getElementById('playlistFilter');
            select.innerHTML = '<option value="">Toutes les playlists</option>';
            
            allPlaylists.forEach(playlist => {
                const option = document.createElement('option');
                option.value = playlist.id;
                option.textContent = playlist.snippet.title;
                select.appendChild(option);
            });
        }

        function updateStats() {
            document.getElementById('totalVideos').textContent = allVideos.length;
            document.getElementById('totalPlaylists').textContent = allPlaylists.length;
            document.getElementById('filteredCount').textContent = getFilteredVideos().length;
        }

        function getFilteredVideos() {
            let filtered = [...allVideos];
            
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const selectedPlaylist = document.getElementById('playlistFilter').value;
            const sortBy = document.getElementById('sortBy').value;
            
            if (searchTerm) {
                filtered = filtered.filter(v => 
                    v.title.toLowerCase().includes(searchTerm) ||
                    v.description.toLowerCase().includes(searchTerm)
                );
            }
            
            if (selectedPlaylist) {
                filtered = filtered.filter(v => v.playlistId === selectedPlaylist);
            }
            
            filtered.sort((a, b) => {
                switch(sortBy) {
                    case 'date-desc':
                        return new Date(b.publishedAt) - new Date(a.publishedAt);
                    case 'date-asc':
                        return new Date(a.publishedAt) - new Date(b.publishedAt);
                    case 'title-asc':
                        return a.title.localeCompare(b.title);
                    case 'title-desc':
                        return b.title.localeCompare(a.title);
                    default:
                        return 0;
                }
            });
            
            return filtered;
        }

        function renderVideos() {
            const container = document.getElementById('videoGrid');
            const filtered = getFilteredVideos();
            
            container.innerHTML = '';
            
            filtered.forEach(video => {
                const card = createVideoCard(video);
                container.appendChild(card);
            });
            
            document.getElementById('filteredCount').textContent = filtered.length;
        }

        function createVideoCard(video) {
            const card = document.createElement('div');
            card.className = 'video-card';
            
            const date = new Date(video.publishedAt).toLocaleDateString('fr-FR');
            
            // Fonction pour √©chapper les caract√®res HTML
            const escapeHtml = (text) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };
            
            // SVG de fallback avec smiley clin d'≈ìil sur fond pastel uni
            const fallbackImage = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22320%22 height=%22180%22%3E%3Crect width=%22320%22 height=%22180%22 fill=%22%23d4b5ff%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2260%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22%3Eüòâ%3C/text%3E%3C/svg%3E';
            
            card.innerHTML = `
                <img src="${escapeHtml(video.thumbnail)}" alt="${escapeHtml(video.title)}" class="video-thumbnail" onerror="this.src='${fallbackImage}'">
                <div class="video-info">
                    <div class="video-playlist">${escapeHtml(video.playlistTitle)}</div>
                    <h3 class="video-title">${escapeHtml(video.title)}</h3>
                    <div class="video-meta">Publi√© le ${date}</div>
                    <div class="video-actions">
                        <button class="btn-small" onclick="openVideo('${escapeHtml(video.id)}')">‚ñ∂ Voir</button>
                        <button class="btn-small" onclick="openPlaylistManager('${escapeHtml(video.id)}')">üìã Playlists</button>
                        <button class="btn-small" onclick="openDeleteModal('${escapeHtml(video.id)}')">üóëÔ∏è Supprimer</button>
                    </div>
                </div>
            `;
            
            return card;
        }

        function openVideo(videoId) {
            window.open(`https://www.youtube.com/watch?v=${videoId}`, '_blank');
        }

        let currentVideoForPlaylist = null;
        let currentVideoPlaylists = [];

        async function openPlaylistManager(videoId) {
            const video = allVideos.find(v => v.id === videoId);
            if (!video) return;
            
            currentVideoForPlaylist = video;
            document.getElementById('playlistVideoTitle').textContent = video.title;
            
            // R√©cup√©rer les playlists actuelles de cette vid√©o
            currentVideoPlaylists = allVideos
                .filter(v => v.id === videoId)
                .map(v => v.playlistId);
            
            // Cr√©er la liste de checkboxes
            const container = document.getElementById('playlistCheckboxes');
            container.innerHTML = '';
            
            allPlaylists.forEach(playlist => {
                const isChecked = currentVideoPlaylists.includes(playlist.id);
                const itemDiv = document.createElement('div');
                itemDiv.className = 'playlist-checkbox-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `playlist-${playlist.id}`;
                checkbox.checked = isChecked;
                checkbox.dataset.playlistId = playlist.id;
                
                const label = document.createElement('label');
                label.htmlFor = `playlist-${playlist.id}`;
                label.textContent = playlist.snippet.title;
                
                itemDiv.appendChild(checkbox);
                itemDiv.appendChild(label);
                
                // Rendre tout le div cliquable
                itemDiv.addEventListener('click', (e) => {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                    }
                });
                
                container.appendChild(itemDiv);
            });
            
            document.getElementById('playlistModal').classList.remove('hidden');
            document.getElementById('playlistModal').style.display = 'flex';
        }

        function closePlaylistModal() {
            document.getElementById('playlistModal').classList.add('hidden');
            document.getElementById('playlistModal').style.display = 'none';
            currentVideoForPlaylist = null;
            currentVideoPlaylists = [];
        }

        async function savePlaylistChanges() {
            if (!currentVideoForPlaylist) return;
            
            const checkboxes = document.querySelectorAll('#playlistCheckboxes input[type="checkbox"]');
            const newPlaylists = [];
            const oldPlaylists = [...currentVideoPlaylists];
            
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    newPlaylists.push(cb.dataset.playlistId);
                }
            });
            
            showLoading();
            
            try {
                // Supprimer des playlists d√©coch√©es
                for (const playlistId of oldPlaylists) {
                    if (!newPlaylists.includes(playlistId)) {
                        const video = allVideos.find(v => v.id === currentVideoForPlaylist.id && v.playlistId === playlistId);
                        if (video && video.playlistItemId) {
                            await gapi.client.youtube.playlistItems.delete({
                                id: video.playlistItemId
                            });
                        }
                    }
                }
                
                // Ajouter aux nouvelles playlists coch√©es
                for (const playlistId of newPlaylists) {
                    if (!oldPlaylists.includes(playlistId)) {
                        await gapi.client.youtube.playlistItems.insert({
                            part: 'snippet',
                            resource: {
                                snippet: {
                                    playlistId: playlistId,
                                    resourceId: {
                                        kind: 'youtube#video',
                                        videoId: currentVideoForPlaylist.id
                                    }
                                }
                            }
                        });
                    }
                }
                
                closePlaylistModal();
                
                // Recharger les donn√©es
                await loadAllData();
                
                alert('‚úÖ Playlists mises √† jour avec succ√®s !');
                
            } catch (error) {
                console.error('Erreur lors de la mise √† jour des playlists:', error);
                alert('‚ùå Erreur lors de la mise √† jour des playlists: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function openDeleteModal(videoId) {
            const video = allVideos.find(v => v.id === videoId);
            if (video) {
                currentVideoToDelete = video;
                document.getElementById('deleteVideoTitle').textContent = video.title;
                document.getElementById('deleteModal').classList.remove('hidden');
                document.getElementById('deleteModal').style.display = 'flex';
            }
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            document.getElementById('deleteModal').style.display = 'none';
            currentVideoToDelete = null;
        }

        async function confirmDelete() {
            if (!currentVideoToDelete) return;
            
            try {
                // Note: La suppression d'une vid√©o n√©cessite de la retirer de toutes les playlists
                // ou de supprimer la vid√©o elle-m√™me (n√©cessite youtube.force-ssl scope)
                await gapi.client.youtube.videos.delete({
                    id: currentVideoToDelete.id
                });
                
                // Retirer la vid√©o de la liste locale
                allVideos = allVideos.filter(v => v.id !== currentVideoToDelete.id);
                
                closeDeleteModal();
                updateStats();
                renderVideos();
                
                alert('Vid√©o supprim√©e avec succ√®s !');
            } catch (error) {
                alert('Erreur lors de la suppression: ' + error.message);
            }
        }

        function showLoading() {
            document.getElementById('loadingIndicator').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').classList.add('hidden');
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.container').prepend(errorDiv);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', renderVideos);
        document.getElementById('playlistFilter').addEventListener('change', renderVideos);
        document.getElementById('sortBy').addEventListener('change', renderVideos);

        // Fermer la modal en cliquant √† l'ext√©rieur
        document.getElementById('deleteModal').addEventListener('click', (e) => {
            if (e.target.id === 'deleteModal') {
                closeDeleteModal();
            }
        });

        document.getElementById('playlistModal').addEventListener('click', (e) => {
            if (e.target.id === 'playlistModal') {
                closePlaylistModal();
            }
        });

        // Initialisation au chargement
        window.addEventListener('load', () => {
            gapiLoaded();
            gisLoaded();
            
            // Pr√©-remplir le Client ID s'il existe
            if (CLIENT_ID) {
                document.getElementById('clientIdInput').value = CLIENT_ID;
            }
        });
    </script>
</body>
</html>
